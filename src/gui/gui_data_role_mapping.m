function handles = gui_data_role_mapping(parent, handles)
%% æ•°æ®è§’è‰²æ˜ å°„GUIæ¨¡å—
% è®©ç”¨æˆ·æŒ‡å®šå“ªä¸ªæ•°æ®å¯¹åº”è¢«åŠ¨æ‚¬æ¶ã€è®¾è®¡ç®—æ³•ç­‰
%
% è¾“å…¥:
%   parent - çˆ¶å®¹å™¨å¯¹è±¡
%   handles - GUIå¥æŸ„ç»“æ„ä½“
%
% è¾“å‡º:  
%   handles - æ›´æ–°åçš„å¥æŸ„ç»“æ„ä½“

    % æ•°æ®è§’è‰²æ˜ å°„é¢æ¿
    rolePanel = uipanel('Parent', parent, ...
                       'Title', 'ğŸ¯ æ•°æ®è§’è‰²æ˜ å°„', ...
                       'Position', [0.02, 0.02, 0.96, 0.96], ...
                       'FontSize', 10, ...
                       'FontWeight', 'bold', ...
                       'BackgroundColor', [1.0, 0.98, 0.95], ...
                       'ForegroundColor', [0.7, 0.3, 0.1]);
    
    % è¯´æ˜æ–‡å­—
    uicontrol('Parent', rolePanel, ...
              'Style', 'text', ...
              'String', ['ğŸ“ è¯·æŒ‡å®šæ•°æ®å¯¹åº”çš„æ‚¬æ¶ç±»å‹ï¼Œä»¥è·å¾—æ­£ç¡®çš„ç»˜å›¾æ ·å¼:', newline, ...
                        'â€¢ è¢«åŠ¨æ‚¬æ¶: è“è‰²è™šçº¿', newline, ...
                        'â€¢ è®¾è®¡ç®—æ³•: é»‘è‰²ç²—å®çº¿'], ...
              'Position', [15, 430, 200, 60], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'ForegroundColor', [0.4, 0.4, 0.4]);
    
    % === è¢«åŠ¨æ‚¬æ¶è®¾ç½® ===
    uicontrol('Parent', rolePanel, ...
              'Style', 'text', ...
              'String', 'ğŸ”µ è¢«åŠ¨æ‚¬æ¶:', ...
              'Position', [15, 395, 80, 20], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'ForegroundColor', [0, 0.4470, 0.7410]);
    
    handles.passiveDropdown = uicontrol('Parent', rolePanel, ...
                                       'Style', 'popupmenu', ...
                                       'String', {'(æœªé€‰æ‹©)', 'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3'}, ...
                                       'Position', [100, 395, 100, 25], ...
                                       'FontSize', 9, ...
                                       'Value', 1, ...
                                       'Callback', {@onRoleMappingChange, handles});
    
    % === è®¾è®¡ç®—æ³•è®¾ç½® ===
    uicontrol('Parent', rolePanel, ...
              'Style', 'text', ...
              'String', 'ğŸ¯ è®¾è®¡ç®—æ³•:', ...
              'Position', [15, 365, 80, 20], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'ForegroundColor', [0, 0, 0]);
    
    handles.designedDropdown = uicontrol('Parent', rolePanel, ...
                                        'Style', 'popupmenu', ...
                                        'String', {'(æœªé€‰æ‹©)', 'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3'}, ...
                                        'Position', [100, 365, 100, 25], ...
                                        'FontSize', 9, ...
                                        'Value', 1, ...
                                        'Callback', {@onRoleMappingChange, handles});
    
    % === åŠä¸»åŠ¨æ‚¬æ¶è®¾ç½®ï¼ˆå¯é€‰ï¼‰===
    uicontrol('Parent', rolePanel, ...
              'Style', 'text', ...
              'String', 'ğŸŸ¡ åŠä¸»åŠ¨æ‚¬æ¶:', ...
              'Position', [15, 335, 80, 20], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'ForegroundColor', [0.8500, 0.3250, 0.0980]);
    
    handles.semiactiveDropdown = uicontrol('Parent', rolePanel, ...
                                          'Style', 'popupmenu', ...
                                          'String', {'(æœªé€‰æ‹©)', 'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3'}, ...
                                          'Position', [100, 335, 100, 25], ...
                                          'FontSize', 9, ...
                                          'Value', 1, ...
                                          'Callback', {@onRoleMappingChange, handles});
    
    % === ä¸»åŠ¨æ‚¬æ¶è®¾ç½®ï¼ˆå¯é€‰ï¼‰===
    uicontrol('Parent', rolePanel, ...
              'Style', 'text', ...
              'String', 'ğŸŸ  ä¸»åŠ¨æ‚¬æ¶:', ...
              'Position', [15, 305, 80, 20], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'ForegroundColor', [0.9290, 0.6940, 0.1250]);
    
    handles.activeDropdown = uicontrol('Parent', rolePanel, ...
                                      'Style', 'popupmenu', ...
                                      'String', {'(æœªé€‰æ‹©)', 'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3'}, ...
                                      'Position', [100, 305, 100, 25], ...
                                      'FontSize', 9, ...
                                      'Value', 1, ...
                                      'Callback', {@onRoleMappingChange, handles});
    
    % === å‚è€ƒæ§åˆ¶å™¨è®¾ç½®ï¼ˆå¯é€‰ï¼‰===
    uicontrol('Parent', rolePanel, ...
              'Style', 'text', ...
              'String', 'ğŸŸ£ å‚è€ƒæ§åˆ¶å™¨:', ...
              'Position', [15, 275, 80, 20], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'ForegroundColor', [0.4940, 0.1840, 0.5560]);
    
    handles.referenceDropdown = uicontrol('Parent', rolePanel, ...
                                         'Style', 'popupmenu', ...
                                         'String', {'(æœªé€‰æ‹©)', 'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3'}, ...
                                         'Position', [100, 275, 100, 25], ...
                                         'FontSize', 9, ...
                                         'Value', 1, ...
                                         'Callback', {@onRoleMappingChange, handles});
    
    % === è‡ªåŠ¨æ˜ å°„æŒ‰é’® ===
    uicontrol('Parent', rolePanel, ...
              'Style', 'pushbutton', ...
              'String', 'ğŸ¤– æ™ºèƒ½æ˜ å°„', ...
              'Position', [15, 240, 90, 25], ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'BackgroundColor', [0.4, 0.8, 0.4], ...
              'ForegroundColor', 'white', ...
              'Callback', {@autoMapping, handles});
    
    % === æ¸…é™¤æ˜ å°„æŒ‰é’® ===
    uicontrol('Parent', rolePanel, ...
              'Style', 'pushbutton', ...
              'String', 'ğŸ—‘ï¸ æ¸…é™¤æ˜ å°„', ...
              'Position', [115, 240, 90, 25], ...
              'FontSize', 9, ...
              'BackgroundColor', [0.9, 0.9, 0.9], ...
              'Callback', {@clearMapping, handles});
    
    % === æ˜ å°„çŠ¶æ€æ˜¾ç¤º ===
    uicontrol('Parent', rolePanel, ...
              'Style', 'text', ...
              'String', 'ğŸ“Š å½“å‰æ˜ å°„çŠ¶æ€:', ...
              'Position', [15, 210, 100, 18], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'FontWeight', 'bold');
    
    handles.mappingStatusText = uicontrol('Parent', rolePanel, ...
                                         'Style', 'text', ...
                                         'String', '(æœªè®¾ç½®)', ...
                                         'Position', [15, 150, 190, 55], ...
                                         'HorizontalAlignment', 'left', ...
                                         'FontSize', 8, ...
                                         'ForegroundColor', [0.5, 0.5, 0.5]);
    
    % === é¢„è§ˆæŒ‰é’® ===
    uicontrol('Parent', rolePanel, ...
              'Style', 'pushbutton', ...
              'String', 'ğŸ‘ï¸ é¢„è§ˆæ ·å¼', ...
              'Position', [15, 110, 90, 30], ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'BackgroundColor', [0.2, 0.6, 0.9], ...
              'ForegroundColor', 'white', ...
              'Callback', {@previewStyles, handles});
    
    % === åº”ç”¨æ˜ å°„æŒ‰é’® ===
    uicontrol('Parent', rolePanel, ...
              'Style', 'pushbutton', ...
              'String', 'âœ… åº”ç”¨æ˜ å°„', ...
              'Position', [115, 110, 90, 30], ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'BackgroundColor', [0.1, 0.7, 0.1], ...
              'ForegroundColor', 'white', ...
              'Callback', {@applyMapping, handles});
    
    % === å¸®åŠ©ä¿¡æ¯ ===
    help_text = ['ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š', newline, ...
                '1. å¯¼å…¥æ•°æ®åé€‰æ‹©å„æ•°æ®çš„è§’è‰²', newline, ...
                '2. è¢«åŠ¨æ‚¬æ¶ä½¿ç”¨è“è‰²è™šçº¿', newline, ...
                '3. è®¾è®¡ç®—æ³•ä½¿ç”¨é»‘è‰²ç²—å®çº¿', newline, ...
                '4. ç‚¹å‡»åº”ç”¨æ˜ å°„åè¿è¡Œåˆ†æ'];
    
    uicontrol('Parent', rolePanel, ...
              'Style', 'text', ...
              'String', help_text, ...
              'Position', [15, 10, 190, 95], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 8, ...
              'ForegroundColor', [0.4, 0.4, 0.4]);
    
    % åˆå§‹åŒ–æ˜ å°„çŠ¶æ€
    updateMappingStatus(handles);
    
end

%% æ›´æ–°ä¸‹æ‹‰åˆ—è¡¨é€‰é¡¹ - ç‹¬ç«‹å‡½æ•°ä¾›å¤–éƒ¨è°ƒç”¨
function updateDataRoleDropdowns(handles)
    if ~isfield(handles, 'data') || isempty(handles.data)
        % æ²¡æœ‰æ•°æ®æ—¶ä½¿ç”¨é»˜è®¤é€‰é¡¹
        data_options = {'(æœªé€‰æ‹©)', 'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3'};
    else
        % æ ¹æ®å®é™…æ•°æ®ç”Ÿæˆé€‰é¡¹
        num_datasets = length(handles.data);
        data_options = cell(1, num_datasets + 1);
        data_options{1} = '(æœªé€‰æ‹©)';
        
        for i = 1:num_datasets
            if isfield(handles, 'labels') && length(handles.labels) >= i
                data_options{i+1} = sprintf('æ•°æ®%d: %s', i, handles.labels{i});
            else
                data_options{i+1} = sprintf('æ•°æ®%d', i);
            end
        end
    end
    
    % æ›´æ–°æ‰€æœ‰ä¸‹æ‹‰åˆ—è¡¨
    dropdowns = {'passiveDropdown', 'designedDropdown', 'semiactiveDropdown', ...
                'activeDropdown', 'referenceDropdown'};
    
    for i = 1:length(dropdowns)
        if isfield(handles, dropdowns{i}) && ishandle(handles.(dropdowns{i}))
            set(handles.(dropdowns{i}), 'String', data_options);
            % å¦‚æœå½“å‰é€‰æ‹©è¶…å‡ºäº†æ–°çš„èŒƒå›´ï¼Œé‡ç½®ä¸ºæœªé€‰æ‹©
            current_val = get(handles.(dropdowns{i}), 'Value');
            if current_val > length(data_options)
                set(handles.(dropdowns{i}), 'Value', 1);
            end
        end
    end
end

%% å›è°ƒå‡½æ•° - è§’è‰²æ˜ å°„æ”¹å˜
function onRoleMappingChange(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    updateMappingStatus(handles);
    gui_utils('addLog', handles, 'æ•°æ®è§’è‰²æ˜ å°„å·²æ›´æ–°');
end

%% æ™ºèƒ½æ˜ å°„
function autoMapping(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    
    if ~isfield(handles, 'data') || isempty(handles.data)
        msgbox('è¯·å…ˆå¯¼å…¥æ•°æ®', 'æç¤º', 'warn');
        return;
    end
    
    num_datasets = length(handles.data);
    
    % æ™ºèƒ½æ˜ å°„é€»è¾‘
    if num_datasets >= 2
        % ç¬¬ä¸€ä¸ªæ•°æ®è®¾ä¸ºè¢«åŠ¨æ‚¬æ¶
        set(handles.passiveDropdown, 'Value', 2);  % æ•°æ®1
        
        % æœ€åä¸€ä¸ªæ•°æ®è®¾ä¸ºè®¾è®¡ç®—æ³•
        set(handles.designedDropdown, 'Value', num_datasets + 1);  % æœ€åä¸€ä¸ªæ•°æ®
        
        % å¦‚æœæœ‰3ä¸ªä»¥ä¸Šæ•°æ®ï¼Œä¸­é—´çš„è®¾ä¸ºåŠä¸»åŠ¨
        if num_datasets >= 3
            set(handles.semiactiveDropdown, 'Value', 3);  % æ•°æ®2
        end
        
        updateMappingStatus(handles);
        gui_utils('addLog', handles, 'æ™ºèƒ½æ˜ å°„å·²å®Œæˆ');
        msgbox('æ™ºèƒ½æ˜ å°„å®Œæˆï¼ç¬¬ä¸€ä¸ªæ•°æ®è®¾ä¸ºè¢«åŠ¨æ‚¬æ¶ï¼Œæœ€åä¸€ä¸ªè®¾ä¸ºè®¾è®¡ç®—æ³•', 'æ™ºèƒ½æ˜ å°„', 'help');
    else
        msgbox('è‡³å°‘éœ€è¦2ä¸ªæ•°æ®é›†æ‰èƒ½è¿›è¡Œæ™ºèƒ½æ˜ å°„', 'æç¤º', 'warn');
    end
end

%% æ¸…é™¤æ˜ å°„
function clearMapping(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    
    % é‡ç½®æ‰€æœ‰ä¸‹æ‹‰åˆ—è¡¨ä¸ºæœªé€‰æ‹©
    dropdowns = {'passiveDropdown', 'designedDropdown', 'semiactiveDropdown', ...
                'activeDropdown', 'referenceDropdown'};
    
    for i = 1:length(dropdowns)
        if isfield(handles, dropdowns{i})
            set(handles.(dropdowns{i}), 'Value', 1);
        end
    end
    
    updateMappingStatus(handles);
    gui_utils('addLog', handles, 'æ•°æ®è§’è‰²æ˜ å°„å·²æ¸…é™¤');
end

%% é¢„è§ˆæ ·å¼
function previewStyles(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    
    % è·å–å½“å‰æ˜ å°„
    mapping = getCurrentMapping(handles);
    
    if isempty(fieldnames(mapping))
        msgbox('è¯·å…ˆè®¾ç½®æ•°æ®è§’è‰²æ˜ å°„', 'æç¤º', 'warn');
        return;
    end
    
    try
        % åˆ›å»ºé¢„è§ˆå›¾
        preview_fig = figure('Name', 'æ•°æ®è§’è‰²æ ·å¼é¢„è§ˆ', 'Position', [200, 200, 500, 350]);
        
        % ç”Ÿæˆç¤ºä¾‹æ•°æ®
        t = 0:0.01:5;
        num_data = 3;
        example_labels = {'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3'};
        
        % ç”Ÿæˆé…ç½®
        config = struct();
        config.data_role_mapping = mapping;
        config.debug = true;
        
        % è·å–æ ·å¼
        [line_styles, colors, line_widths] = get_data_role_styles(example_labels, mapping, config);
        
        % ç»˜åˆ¶ç¤ºä¾‹
        hold on;
        for i = 1:num_data
            y = sin(2*pi*t + (i-1)*pi/3) * exp(-0.1*t);
            plot(t, y, line_styles{i}, 'LineWidth', line_widths(i), ...
                 'Color', colors(i,:), 'DisplayName', example_labels{i});
        end
        
        xlabel('æ—¶é—´ (s)');
        ylabel('ç¤ºä¾‹ä¿¡å·');
        title('æ•°æ®è§’è‰²æ ·å¼é¢„è§ˆ');
        legend('Location', 'best');
        grid on;
        
        gui_utils('addLog', handles, 'æ ·å¼é¢„è§ˆå·²ç”Ÿæˆ');
        
    catch ME
        gui_utils('addLog', handles, sprintf('æ ·å¼é¢„è§ˆå¤±è´¥: %s', ME.message));
    end
end

%% åº”ç”¨æ˜ å°„
function applyMapping(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    
    % è·å–å½“å‰æ˜ å°„
    mapping = getCurrentMapping(handles);
    
    % ä¿å­˜åˆ°é…ç½®ä¸­
    if isfield(handles, 'config')
        handles.config.data_role_mapping = mapping;
    else
        handles.config = struct();
        handles.config.data_role_mapping = mapping;
    end
    
    % æ›´æ–°å¥æŸ„
    set(handles.fig, 'UserData', handles);
    
    updateMappingStatus(handles);
    gui_utils('addLog', handles, 'æ•°æ®è§’è‰²æ˜ å°„å·²åº”ç”¨åˆ°åˆ†æé…ç½®');
    
    if ~isempty(fieldnames(mapping))
        msgbox('æ•°æ®è§’è‰²æ˜ å°„å·²åº”ç”¨ï¼è¿è¡Œåˆ†ææ—¶å°†ä½¿ç”¨æŒ‡å®šçš„ç»˜å›¾æ ·å¼', 'åº”ç”¨æˆåŠŸ', 'help');
    end
end

%% è·å–å½“å‰æ˜ å°„
function mapping = getCurrentMapping(handles)
    mapping = struct();
    
    % è¢«åŠ¨æ‚¬æ¶
    passive_val = get(handles.passiveDropdown, 'Value');
    if passive_val > 1
        mapping.passive_index = passive_val - 1;
    end
    
    % è®¾è®¡ç®—æ³•
    designed_val = get(handles.designedDropdown, 'Value');
    if designed_val > 1
        mapping.designed_index = designed_val - 1;
    end
    
    % åŠä¸»åŠ¨æ‚¬æ¶
    semiactive_val = get(handles.semiactiveDropdown, 'Value');
    if semiactive_val > 1
        mapping.semiactive_index = semiactive_val - 1;
    end
    
    % ä¸»åŠ¨æ‚¬æ¶
    active_val = get(handles.activeDropdown, 'Value');
    if active_val > 1
        mapping.active_index = active_val - 1;
    end
    
    % å‚è€ƒæ§åˆ¶å™¨
    reference_val = get(handles.referenceDropdown, 'Value');
    if reference_val > 1
        mapping.reference_index = reference_val - 1;
    end
end

%% æ›´æ–°æ˜ å°„çŠ¶æ€æ˜¾ç¤º
function updateMappingStatus(handles)
    mapping = getCurrentMapping(handles);
    
    status_lines = {};
    
    if isfield(mapping, 'passive_index')
        status_lines{end+1} = sprintf('ğŸ”µ è¢«åŠ¨æ‚¬æ¶: æ•°æ®%d', mapping.passive_index);
    end
    
    if isfield(mapping, 'designed_index')
        status_lines{end+1} = sprintf('ğŸ¯ è®¾è®¡ç®—æ³•: æ•°æ®%d', mapping.designed_index);
    end
    
    if isfield(mapping, 'semiactive_index')
        status_lines{end+1} = sprintf('ğŸŸ¡ åŠä¸»åŠ¨: æ•°æ®%d', mapping.semiactive_index);
    end
    
    if isfield(mapping, 'active_index')
        status_lines{end+1} = sprintf('ğŸŸ  ä¸»åŠ¨: æ•°æ®%d', mapping.active_index);
    end
    
    if isfield(mapping, 'reference_index')
        status_lines{end+1} = sprintf('ğŸŸ£ å‚è€ƒ: æ•°æ®%d', mapping.reference_index);
    end
    
    if isempty(status_lines)
        status_text = '(æœªè®¾ç½®)';
    else
        status_text = strjoin(status_lines, newline);
    end
    
    set(handles.mappingStatusText, 'String', status_text);
end
