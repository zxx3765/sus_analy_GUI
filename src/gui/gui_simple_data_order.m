function handles = gui_simple_data_order(parent, handles)
%% ç®€åŒ–çš„æ•°æ®é¡ºåºè®¾ç½®GUIæ¨¡å—ï¼ˆç¾åŒ–å¸ƒå±€ç‰ˆï¼‰
% ç›®æ ‡ï¼šæ›´æ¸…çˆ½çš„ä¸¤åˆ—å¸ƒå±€ï¼Œæ”¯æŒç¼©æ”¾ï¼Œç»Ÿä¸€ç•™ç™½ä¸é…è‰²
%
% è¾“å…¥:
%   parent - çˆ¶å®¹å™¨å¯¹è±¡
%   handles - GUIå¥æŸ„ç»“æ„ä½“
%
% è¾“å‡º:
%   handles - æ›´æ–°åçš„å¥æŸ„ç»“æ„ä½“

    % å®¹å™¨é¢æ¿
    orderPanel = uipanel('Parent', parent, ...
                        'Title', 'ğŸ“Š æ•°æ®é¡ºåºè®¾ç½®', ...
                        'Units', 'normalized', ...
                        'Position', [0.02, 0.02, 0.96, 0.96], ...
                        'FontSize', 10, ...
                        'FontWeight', 'bold', ...
                        'BackgroundColor', [0.98, 0.99, 0.98], ...
                        'ForegroundColor', [0.18, 0.45, 0.30]);

    % å·¦åˆ—ï¼šåŸºç¡€è®¾ç½®ä¸æ“ä½œ
    leftPanel = uipanel('Parent', orderPanel, ...
                        'BorderType', 'none', ...
                        'Units', 'normalized', ...
                        'Position', [0.02, 0.05, 0.46, 0.90], ...
                        'BackgroundColor', [0.98, 0.99, 0.98]);

    % é¡¶éƒ¨è¯´æ˜
    uicontrol('Parent', leftPanel, ...
              'Style', 'text', ...
              'Units', 'normalized', ...
              'String', ['ğŸ“ æŒ‡å®šç»˜å›¾ä¸­çš„ç‰¹æ®Šæ•°æ®', newline, ...
                        'â€¢ ç¬¬ä¸€ä¸ª: è™šçº¿', newline, ...
                        'â€¢ æœ€åä¸€ä¸ª: é»‘è‰²å®çº¿', newline, ...
                        'â€¢ å…¶ä»–: è‡ªåŠ¨é¢œè‰²å®çº¿'], ...
              'Position', [0.00, 0.80, 1.00, 0.18], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'ForegroundColor', [0.35, 0.35, 0.35], ...
              'BackgroundColor', [0.98, 0.99, 0.98]);

    % è¡Œ1ï¼šç¬¬ä¸€ä¸ªæ•°æ®
    uicontrol('Parent', leftPanel, ...
              'Style', 'text', ...
              'Units', 'normalized', ...
              'String', 'ğŸ“ˆ ç¬¬ä¸€ä¸ªæ•°æ® (è™šçº¿)', ...
              'Position', [0.00, 0.70, 0.48, 0.06], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'ForegroundColor', [0.00, 0.45, 0.74], ...
              'BackgroundColor', [0.98, 0.99, 0.98]);

    handles.firstDataDropdown = uicontrol('Parent', leftPanel, ...
                                         'Style', 'popupmenu', ...
                                         'Units', 'normalized', ...
                                         'String', {'(é»˜è®¤ç¬¬1ä¸ª)', 'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3'}, ...
                                         'Position', [0.50, 0.70, 0.48, 0.06], ...
                                         'FontSize', 9, ...
                                         'Value', 1, ...
                                         'Callback', {@onDataOrderChange, handles});

    % è¡Œ2ï¼šæœ€åä¸€ä¸ªæ•°æ®
    uicontrol('Parent', leftPanel, ...
              'Style', 'text', ...
              'Units', 'normalized', ...
              'String', 'ğŸ¯ æœ€åæ•°æ® (é»‘è‰²å®çº¿)', ...
              'Position', [0.00, 0.60, 0.48, 0.06], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'ForegroundColor', [0.00, 0.00, 0.00], ...
              'BackgroundColor', [0.98, 0.99, 0.98]);

    handles.lastDataDropdown = uicontrol('Parent', leftPanel, ...
                                        'Style', 'popupmenu', ...
                                        'Units', 'normalized', ...
                                        'String', {'(é»˜è®¤æœ€å1ä¸ª)', 'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3'}, ...
                                        'Position', [0.50, 0.60, 0.48, 0.06], ...
                                        'FontSize', 9, ...
                                        'Value', 1, ...
                                        'Callback', {@onDataOrderChange, handles});

    % è¡Œ3ï¼šæŒ‰é’®åŒº
    uicontrol('Parent', leftPanel, ...
              'Style', 'pushbutton', ...
              'Units', 'normalized', ...
              'String', 'ğŸš€ æ™ºèƒ½è®¾ç½®', ...
              'Position', [0.00, 0.50, 0.48, 0.07], ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'BackgroundColor', [0.40, 0.80, 0.40], ...
              'ForegroundColor', 'white', ...
              'Callback', {@smartSetting, handles}, ...
              'TooltipString', 'ç¬¬1ä¸ªæ•°æ®è®¾ä¸ºç¬¬ä¸€ä¸ªï¼Œæœ€å1ä¸ªæ•°æ®è®¾ä¸ºæœ€åä¸€ä¸ª');

    uicontrol('Parent', leftPanel, ...
              'Style', 'pushbutton', ...
              'Units', 'normalized', ...
              'String', 'ğŸ”„ é‡ç½®', ...
              'Position', [0.50, 0.50, 0.48, 0.07], ...
              'FontSize', 9, ...
              'BackgroundColor', [0.90, 0.90, 0.90], ...
              'Callback', {@resetSetting, handles});

    % è¡Œ4ï¼šå½“å‰è®¾ç½®
    uicontrol('Parent', leftPanel, ...
              'Style', 'text', ...
              'Units', 'normalized', ...
              'String', 'ğŸ“Š å½“å‰è®¾ç½®', ...
              'Position', [0.00, 0.41, 1.00, 0.05], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'BackgroundColor', [0.98, 0.99, 0.98]);

    handles.orderStatusText = uicontrol('Parent', leftPanel, ...
                                       'Style', 'text', ...
                                       'Units', 'normalized', ...
                                       'String', 'é»˜è®¤é¡ºåº', ...
                                       'Position', [0.00, 0.30, 1.00, 0.10], ...
                                       'HorizontalAlignment', 'left', ...
                                       'FontSize', 8, ...
                                       'ForegroundColor', [0.45, 0.45, 0.45], ...
                                       'BackgroundColor', [0.98, 0.99, 0.98]);

    % è¡Œ5ï¼šé¢„è§ˆä¸åº”ç”¨
    uicontrol('Parent', leftPanel, ...
              'Style', 'pushbutton', ...
              'Units', 'normalized', ...
              'String', 'ğŸ‘ï¸ é¢„è§ˆæ•ˆæœ', ...
              'Position', [0.00, 0.20, 0.48, 0.08], ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'BackgroundColor', [0.20, 0.60, 0.90], ...
              'ForegroundColor', 'white', ...
              'Callback', {@previewOrder, handles});

    uicontrol('Parent', leftPanel, ...
              'Style', 'pushbutton', ...
              'Units', 'normalized', ...
              'String', 'âœ… åº”ç”¨è®¾ç½®', ...
              'Position', [0.50, 0.20, 0.48, 0.08], ...
              'FontSize', 9, ...
              'FontWeight', 'bold', ...
              'BackgroundColor', [0.10, 0.70, 0.10], ...
              'ForegroundColor', 'white', ...
              'Callback', {@applyOrder, handles});

    % è¡Œ6ï¼šå¸®åŠ©
    help_text = ['ğŸ’¡ ä½¿ç”¨è¯´æ˜', newline, ...
                 '1) é€‰æ‹©è™šçº¿ä¸é»‘è‰²å®çº¿å¯¹åº”æ•°æ®', newline, ...
                 '2) å¯å¯ç”¨å³ä¾§è‡ªå®šä¹‰é¡ºåºè¦†ç›–', newline, ...
                 '3) é¢„è§ˆç¡®è®¤ååº”ç”¨å³å¯'];
    uicontrol('Parent', leftPanel, ...
              'Style', 'text', ...
              'Units', 'normalized', ...
              'String', help_text, ...
              'Position', [0.00, 0.03, 1.00, 0.14], ...
              'HorizontalAlignment', 'left', ...
              'FontSize', 8, ...
              'ForegroundColor', [0.35, 0.35, 0.35], ...
              'BackgroundColor', [0.98, 0.99, 0.98]);

    % å³åˆ—ï¼šè‡ªå®šä¹‰é¡ºåº
    customOrderPanel = uipanel('Parent', orderPanel, ...
              'Title', 'ğŸ“‹ è‡ªå®šä¹‰é¡ºåºï¼ˆå¯é€‰ï¼‰', ...
              'Units', 'normalized', ...
              'Position', [0.52, 0.05, 0.46, 0.90], ...
              'FontSize', 10, ...
              'FontWeight', 'bold', ...
              'BackgroundColor', [0.97, 0.98, 1.00]);

    handles.enableCustomOrderCheck = uicontrol('Parent', customOrderPanel, ...
              'Style', 'checkbox', ...
              'String', 'å¯ç”¨è‡ªå®šä¹‰é¡ºåºï¼ˆä¼˜å…ˆäºå·¦ä¾§è®¾ç½®ï¼‰', ...
              'Units', 'normalized', ...
              'Position', [0.02, 0.86, 0.96, 0.10], ...
              'Value', 0, ...
              'FontSize', 9, ...
              'BackgroundColor', [0.97, 0.98, 1.00]);

    handles.customOrderList = uicontrol('Parent', customOrderPanel, ...
              'Style', 'listbox', ...
              'Units', 'normalized', ...
              'Position', [0.02, 0.12, 0.70, 0.72], ...
              'FontSize', 9, ...
              'Max', 2, ...
              'Min', 0, ...
              'BackgroundColor', 'white');

    handles.btnMoveUp = uicontrol('Parent', customOrderPanel, ...
              'Style', 'pushbutton', ...
              'String', 'ä¸Šç§»', ...
              'Units', 'normalized', ...
              'Position', [0.74, 0.70, 0.24, 0.14], ...
              'FontSize', 9, ...
              'Callback', {@onCustomOrderMove, handles, 'up'});

    handles.btnMoveDown = uicontrol('Parent', customOrderPanel, ...
              'Style', 'pushbutton', ...
              'String', 'ä¸‹ç§»', ...
              'Units', 'normalized', ...
              'Position', [0.74, 0.54, 0.24, 0.14], ...
              'FontSize', 9, ...
              'Callback', {@onCustomOrderMove, handles, 'down'});

    handles.btnMoveTop = uicontrol('Parent', customOrderPanel, ...
              'Style', 'pushbutton', ...
              'String', 'ç½®é¡¶', ...
              'Units', 'normalized', ...
              'Position', [0.74, 0.38, 0.24, 0.14], ...
              'FontSize', 9, ...
              'Callback', {@onCustomOrderMove, handles, 'top'});

    handles.btnMoveBottom = uicontrol('Parent', customOrderPanel, ...
              'Style', 'pushbutton', ...
              'String', 'ç½®åº•', ...
              'Units', 'normalized', ...
              'Position', [0.74, 0.22, 0.24, 0.14], ...
              'FontSize', 9, ...
              'Callback', {@onCustomOrderMove, handles, 'bottom'});

    handles.btnOrderReset = uicontrol('Parent', customOrderPanel, ...
              'Style', 'pushbutton', ...
              'String', 'é‡ç½®é¡ºåº', ...
              'Units', 'normalized', ...
              'Position', [0.74, 0.06, 0.24, 0.12], ...
              'FontSize', 9, ...
              'Callback', {@onCustomOrderReset, handles});

    % åˆå§‹åŒ–ä¸‹æ‹‰ä¸çŠ¶æ€æ˜¾ç¤º
    if exist('updateSimpleDataOrderDropdowns', 'file') == 2
        try
            updateSimpleDataOrderDropdowns(handles);
        catch
        end
    end
    updateOrderStatus(handles);
    % åˆå§‹åŒ–è‡ªå®šä¹‰é¡ºåºåˆ—è¡¨
    if exist('updateCustomOrderList', 'file') == 2
        try
            updateCustomOrderList(handles);
        catch
        end
    end

end


%% å›è°ƒå‡½æ•° - æ•°æ®é¡ºåºæ”¹å˜
function onDataOrderChange(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    updateOrderStatus(handles);
    gui_utils('addLog', handles, 'æ•°æ®é¡ºåºè®¾ç½®å·²æ›´æ–°');
end

%% æ™ºèƒ½è®¾ç½®
function smartSetting(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    
    if ~isfield(handles, 'data') || isempty(handles.data)
        msgbox('è¯·å…ˆå¯¼å…¥æ•°æ®', 'æç¤º', 'warn');
        return;
    end
    
    num_datasets = length(handles.data);
    
    if num_datasets >= 2
        % ç¬¬ä¸€ä¸ªæ•°æ®è®¾ä¸ºç¬¬ä¸€ä¸ª
        set(handles.firstDataDropdown, 'Value', 2);  % æ•°æ®1
        
        % æœ€åä¸€ä¸ªæ•°æ®è®¾ä¸ºæœ€åä¸€ä¸ª
        set(handles.lastDataDropdown, 'Value', num_datasets + 1);  % æœ€åä¸€ä¸ªæ•°æ®
        
        updateOrderStatus(handles);
        gui_utils('addLog', handles, 'æ™ºèƒ½è®¾ç½®å®Œæˆ');
        msgbox('æ™ºèƒ½è®¾ç½®å®Œæˆï¼ç¬¬1ä¸ªæ•°æ®è®¾ä¸ºè™šçº¿ï¼Œæœ€å1ä¸ªæ•°æ®è®¾ä¸ºé»‘è‰²å®çº¿', 'æ™ºèƒ½è®¾ç½®', 'help');
    else
        msgbox('è‡³å°‘éœ€è¦2ä¸ªæ•°æ®é›†æ‰èƒ½è¿›è¡Œæ™ºèƒ½è®¾ç½®', 'æç¤º', 'warn');
    end
end

%% é‡ç½®è®¾ç½®
function resetSetting(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    
    % é‡ç½®ä¸‹æ‹‰åˆ—è¡¨ä¸ºé»˜è®¤
    set(handles.firstDataDropdown, 'Value', 1);
    set(handles.lastDataDropdown, 'Value', 1);
    
    % é‡ç½®è‡ªå®šä¹‰é¡ºåº
    if exist('updateCustomOrderList', 'file') == 2
        try
            updateCustomOrderList(handles);
        catch
        end
    end

    updateOrderStatus(handles);
    gui_utils('addLog', handles, 'æ•°æ®é¡ºåºè®¾ç½®å·²é‡ç½®');
end

%% é¢„è§ˆæ•ˆæœ
function previewOrder(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    
    % è·å–å½“å‰è®¾ç½®
    order_mapping = getCurrentOrderMapping(handles);
    
    try
        % åˆ›å»ºé¢„è§ˆå›¾
        figure('Name', 'æ•°æ®é¡ºåºé¢„è§ˆ', 'Position', [200, 200, 500, 350]);
        
        % ç”Ÿæˆç¤ºä¾‹æ•°æ®
        t = 0:0.01:3;
        num_data = 4;  % ç¤ºä¾‹4ä¸ªæ•°æ®
        example_labels = {'æ•°æ®1', 'æ•°æ®2', 'æ•°æ®3', 'æ•°æ®4'};
        
        % ç”Ÿæˆé…ç½®
        config = struct();
        config.data_order_mapping = order_mapping;
        config.debug = true;
        config.plot.figure_size = [500, 350];
        
        % è·å–æ ·å¼
        [line_styles, colors, line_widths] = get_simple_data_styles(example_labels, order_mapping, config);
        
        % ç»˜åˆ¶ç¤ºä¾‹
        hold on;
        for i = 1:num_data
            y = sin(2*pi*t + (i-1)*pi/4) * exp(-0.1*t);
            plot(t, y, line_styles{i}, 'LineWidth', line_widths(i), ...
                 'Color', colors(i,:), 'DisplayName', example_labels{i});
        end
        
        xlabel('æ—¶é—´ (s)');
        ylabel('ç¤ºä¾‹ä¿¡å·');
        title('æ•°æ®é¡ºåºæ ·å¼é¢„è§ˆ');
        legend('Location', 'best');
        grid on;
        
        gui_utils('addLog', handles, 'é¡ºåºé¢„è§ˆå·²ç”Ÿæˆ');
        
    catch ME
        gui_utils('addLog', handles, sprintf('é¢„è§ˆç”Ÿæˆå¤±è´¥: %s', ME.message));
    end
end

%% åº”ç”¨è®¾ç½®
function applyOrder(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    
    % è·å–å½“å‰è®¾ç½®
    order_mapping = getCurrentOrderMapping(handles);
    
    % å¤„ç†è‡ªå®šä¹‰é¡ºåº
    try
        if isfield(handles, 'enableCustomOrderCheck') && get(handles.enableCustomOrderCheck, 'Value') == 1 ...
                && isfield(handles, 'customOrderList') && ishandle(handles.customOrderList)
            idxs = get(handles.customOrderList, 'UserData');
            if isnumeric(idxs) && ~isempty(idxs)
                handles.config.data_order_list = idxs(:)';
            end
        else
            if isfield(handles, 'config') && isfield(handles.config, 'data_order_list')
                handles.config = rmfield(handles.config, 'data_order_list');
            end
        end
    catch
    end
    
    % ä¿å­˜åˆ°é…ç½®ä¸­
    if isfield(handles, 'config')
        handles.config.data_order_mapping = order_mapping;
    else
        handles.config = struct();
        handles.config.data_order_mapping = order_mapping;
    end
    
    % æ›´æ–°å¥æŸ„
    set(handles.fig, 'UserData', handles);
    
    updateOrderStatus(handles);
    gui_utils('addLog', handles, 'æ•°æ®é¡ºåºè®¾ç½®å·²åº”ç”¨åˆ°åˆ†æé…ç½®');
    
    if ~isempty(fieldnames(order_mapping))
        msgbox('æ•°æ®é¡ºåºè®¾ç½®å·²åº”ç”¨ï¼è¿è¡Œåˆ†ææ—¶å°†ä½¿ç”¨æŒ‡å®šçš„æ ·å¼', 'åº”ç”¨æˆåŠŸ', 'help');
    end
end

%% è‡ªå®šä¹‰é¡ºåºç§»åŠ¨
function onCustomOrderMove(~, ~, handles, action)
    handles = get(handles.fig, 'UserData');
    if ~isfield(handles, 'customOrderList') || ~ishandle(handles.customOrderList)
        return;
    end
    idxs = get(handles.customOrderList, 'UserData');
    sel = get(handles.customOrderList, 'Value');
    if isempty(idxs) || isempty(sel)
        return;
    end
    i = sel(1);
    switch action
        case 'up'
            if i > 1
                idxs([i-1 i]) = idxs([i i-1]);
                i = i-1;
            end
        case 'down'
            if i < numel(idxs)
                idxs([i i+1]) = idxs([i+1 i]);
                i = i+1;
            end
        case 'top'
            if i > 1
                v = idxs(i); idxs(i) = []; idxs = [v idxs]; i = 1;
            end
        case 'bottom'
            if i < numel(idxs)
                v = idxs(i); idxs(i) = []; idxs(end+1) = v; i = numel(idxs);
            end
    end
    labels = handles.labels;
    strs = arrayfun(@(k) sprintf('%d. %s', idxs(k), labels{idxs(k)}), 1:numel(idxs), 'UniformOutput', false);
    set(handles.customOrderList, 'String', strs);
    set(handles.customOrderList, 'UserData', idxs);
    set(handles.customOrderList, 'Value', i);
end

function onCustomOrderReset(~, ~, handles)
    handles = get(handles.fig, 'UserData');
    if ~isfield(handles, 'labels') || isempty(handles.labels)
        set(handles.customOrderList, 'String', {'(æ— æ•°æ®)'});
        set(handles.customOrderList, 'UserData', []);
        return;
    end
    labels = handles.labels;
    idxs = 1:numel(labels);
    strs = arrayfun(@(i) sprintf('%d. %s', i, labels{i}), idxs, 'UniformOutput', false);
    set(handles.customOrderList, 'String', strs);
    set(handles.customOrderList, 'UserData', idxs);
    set(handles.customOrderList, 'Value', 1);
end

%% è·å–å½“å‰é¡ºåºè®¾ç½®
function order_mapping = getCurrentOrderMapping(handles)
    order_mapping = struct();
    
    % ç¬¬ä¸€ä¸ªæ•°æ®
    first_val = get(handles.firstDataDropdown, 'Value');
    if first_val > 1
        order_mapping.first_index = first_val - 1;
    end
    
    % æœ€åä¸€ä¸ªæ•°æ®
    last_val = get(handles.lastDataDropdown, 'Value');
    if last_val > 1
        order_mapping.last_index = last_val - 1;
    end
end

%% æ›´æ–°çŠ¶æ€æ˜¾ç¤º
function updateOrderStatus(handles)
    order_mapping = getCurrentOrderMapping(handles);
    
    status_lines = {};
    
    if isfield(order_mapping, 'first_index')
        status_lines{end+1} = sprintf('ğŸ“ˆ ç¬¬ä¸€ä¸ª: æ•°æ®%d (è™šçº¿)', order_mapping.first_index);
    else
        status_lines{end+1} = 'ğŸ“ˆ ç¬¬ä¸€ä¸ª: é»˜è®¤ç¬¬1ä¸ª (è™šçº¿)';
    end
    
    if isfield(order_mapping, 'last_index')
        status_lines{end+1} = sprintf('ğŸ¯ æœ€åä¸€ä¸ª: æ•°æ®%d (é»‘è‰²)', order_mapping.last_index);
    else
        status_lines{end+1} = 'ğŸ¯ æœ€åä¸€ä¸ª: é»˜è®¤æœ€å1ä¸ª (é»‘è‰²)';
    end
    
    status_lines{end+1} = 'ğŸŒˆ å…¶ä»–: è‡ªåŠ¨é¢œè‰²å®çº¿';
    
    status_text = strjoin(status_lines, newline);
    set(handles.orderStatusText, 'String', status_text);
end
